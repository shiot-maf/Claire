<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ê´€ë¦¬ì í˜ì´ì§€</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: #f4f6f9;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 30px;
      background: #fff;
      display: flex;
      flex-direction: column;
    }
    h1 {
      color: #14532d;
      font-size: 24px;
      margin-bottom: 20px;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .filters {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
      gap: 10px;
      flex-wrap: wrap;
    }
    button.action, .student-button, .tab-button, .class-button {
      background-color: #15803d;
      color: white;
      padding: 10px 15px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    button.action:hover, .student-button:hover, .tab-button:hover, .class-button:hover {
      background-color: #14532d;
    }
    .logout-button {
      background-color: #991b1b;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
    }
    .student-list {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
    }
    .comment-entry {
      border-bottom: 1px solid #ccc;
      padding: 8px 0;
      white-space: pre-wrap;
    }
    .comment-entry button {
      background-color: #991b1b;
      color: white;
      border: none;
      padding: 4px 8px;
      border-radius: 4px;
      margin-top: 4px;
      cursor: pointer;
    }
    .tab-button.active {
      background-color: #0f5132;
    }
  </style>
  <script>
    const classGroups = {
      "ì›”ìˆ˜ê¸ˆ": {
        "Intro": ["ê³½ì´ë‚˜", "ìµœê°€ë¦¼", "í™©ë„ìœ¤", "ê¹€ì‹œì—°"],
        "HighUP(LG2)": ["ì„±ì˜ˆì›", "ì¡°ìœ¤ì°¬", "ê°•ìœ ì¤€", "ì§„ìˆ˜í˜", "ì •ë¯¼ì„œ", "ê¹€íƒœìœ¤", "ì´ì§€ëª½"],
        "FlyUP(LG3)": ["ë°•ì‹ ìš°", "ê¹€íƒœìœ¤(KTY)", "ì´ì±„ì€", "ì´ì±„ìœ¨", "ì–‘ì¸ì˜", "ìµœì†Œì€", "ì–‘ì§€ìœ¤"],
        "Journeys2": ["ì„ì‹œìœ¤", "ì¡°ì€ì •", "ì¡°í˜œì¸", "ì¡°ì€í˜¸", "ì˜¤ì„œì›", "ìœ ì€ìš°"],
        "Phonics1": ["ì„œì£¼ì›", "ê¹€ìœ¤ì„¤", "ë³€ì€ì°¬"],
        "IAS": ["ê¹€ì±„ì•ˆ", "ìµœì›í™"],
        "M1": ["ì´ì„œí˜„", "ì´ì‹œìš°", "ì´ê·œì„±"],
        "M2": ["ë°•íƒœìœ¤", "ì„œì™„í¬", "ê¹€ë¯¼ì£¼", "ì¶”ì„ ìš°"]
      },
      "í™”ëª©": {
        "Phonics2": ["ì´ì¬ë°±", "ê¹€ì‹œìœ¤", "ì¡°ìœ¤ì„œ", "ë°•ì„¤ë¯¼", "ê¹€ë¦¬ì˜¨"],
        "JumpUP(LG1)": ["ê¹€ì—¬ì›"],
        "Arete": ["í™ì§€í›ˆ"],
        "M1": ["ì´í˜„ì°¬", "ê¹€ì§„ì„œ", "ì •ì˜ìœ¤", "ì •ì˜ë‹´", "ì¶”ì„ ìš°"],
        "M3": ["ìœ ì‹œì˜"]
      }
    };

    let allStudents = [];
    for (const days in classGroups) {
      for (const cls in classGroups[days]) {
        allStudents.push(...classGroups[days][cls]);
      }
    }
    allStudents = [...new Set(allStudents)].sort();

    let currentView = 'student';

    window.onload = () => {
      const teacherId = localStorage.getItem("teacherId") || "";
      if (teacherId !== "admin") {
        alert("ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
        location.href = "index.html";
        return;
      }
      document.getElementById("teacherName").textContent = teacherId;
      renderTabs();
      renderContent();
    };

    function logout() {
      localStorage.removeItem("teacherId");
      location.href = "index.html";
    }

    function renderTabs() {
      const tabs = document.getElementById("viewTabs");
      tabs.innerHTML = '';
      [
        { id: 'student', label: 'í•™ìƒë³„ ë³´ê¸°' },
        { id: 'class', label: 'ë°˜ë³„ ë³´ê¸°' }
      ].forEach(tab => {
        const btn = document.createElement("button");
        btn.textContent = tab.label;
        btn.className = "tab-button" + (currentView === tab.id ? " active" : "");
        btn.onclick = () => {
          currentView = tab.id;
          renderTabs();
          renderContent();
        };
        tabs.appendChild(btn);
      });
    }

    function renderContent() {
      const studentList = document.getElementById("studentList");
      studentList.innerHTML = '';
      if (currentView === 'student') {
        allStudents.forEach(name => {
          const btn = document.createElement("button");
          btn.className = "student-button";
          btn.textContent = name;
          btn.onclick = () => filterByStudent(name);
          studentList.appendChild(btn);
        });
      } else if (currentView === 'class') {
        for (const group in classGroups) {
          const groupHeader = document.createElement("h3");
          groupHeader.textContent = `${group} ìš”ì¼`;
          studentList.appendChild(groupHeader);

          for (const cls in classGroups[group]) {
            const clsBtn = document.createElement("button");
            clsBtn.className = "class-button";
            clsBtn.textContent = `ğŸ“˜ ${cls}`;
            clsBtn.onclick = () => showStudentsInClass(classGroups[group][cls]);
            studentList.appendChild(clsBtn);
          }
        }
      }
      renderFilteredLogs();
    }

    function showStudentsInClass(studentArray) {
      const studentList = document.getElementById("studentList");
      studentList.innerHTML = '';
      studentArray.forEach(name => {
        const btn = document.createElement("button");
        btn.className = "student-button";
        btn.textContent = name;
        btn.onclick = () => filterByStudent(name);
        studentList.appendChild(btn);
      });
    }

    function filterByStudent(name) {
      document.getElementById("selectedStudent").value = name;
      renderFilteredLogs();
    }

    function renderFilteredLogs() {
      const allLogs = JSON.parse(localStorage.getItem("studentLogs") || "{}");
      const selectedMonth = document.getElementById("monthSelect").value;
      const selectedStudent = document.getElementById("selectedStudent").value;
      const history = document.getElementById("commentHistory");
      history.innerHTML = "";

      allStudents.forEach(student => {
        if (selectedStudent && student !== selectedStudent) return;
        const logs = allLogs[student] || [];
        if (logs.length === 0) {
          const emptyEntry = document.createElement("div");
          emptyEntry.className = "comment-entry";
          emptyEntry.innerHTML = `<strong>${student}</strong> - í‰ê°€ ê¸°ë¡ ì—†ìŒ`;
          history.appendChild(emptyEntry);
        } else {
          logs.forEach((log, index) => {
            if (!selectedMonth || log.date.startsWith(selectedMonth.replace(/-/g, "."))) {
              const entry = document.createElement("div");
              entry.className = "comment-entry";
              entry.innerHTML = `<strong>${student} | ${log.date} - ${log.teacher}</strong><div>${log.comment}</div>`;
              const deleteBtn = document.createElement("button");
              deleteBtn.textContent = "ì‚­ì œ";
              deleteBtn.onclick = () => deleteComment(student, log, index);
              entry.appendChild(deleteBtn);
              history.appendChild(entry);
            }
          });
        }
      });
    }

    function deleteComment(student, log, index) {
      const allLogs = JSON.parse(localStorage.getItem("studentLogs") || "{}");
      const logs = allLogs[student];
      const targetIndex = logs.findIndex(l => l.date === log.date && l.teacher === log.teacher && l.comment === log.comment);
      if (targetIndex !== -1) {
        if (confirm("ì •ë§ ì´ í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
          logs.splice(targetIndex, 1);
          localStorage.setItem("studentLogs", JSON.stringify(allLogs));
          renderFilteredLogs();
        }
      }
    }

    function downloadAllCSV() {
      const allLogs = JSON.parse(localStorage.getItem("studentLogs") || "{}");
      const selectedMonth = document.getElementById("monthSelect").value;
      const selectedStudent = document.getElementById("selectedStudent").value;
      const rows = [["í•™ìƒëª…", "ë‚ ì§œ", "ì„ ìƒë‹˜", "ë‚´ìš©"]];
      for (const student of allStudents) {
        if (selectedStudent && student !== selectedStudent) continue;
        const logs = allLogs[student] || [];
        logs.forEach(log => {
          if (!selectedMonth || log.date.startsWith(selectedMonth.replace(/-/g, "."))) {
            rows.push([student, log.date, log.teacher, log.comment]);
          }
        });
      }
      const csvContent = rows.map(e => e.map(cell => `"${cell}"`).join(",")).join("\n");
      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = `ì „ì²´_í•™ìƒ_í‰ê°€(${selectedMonth || 'ì „ì²´'}).csv`;
      link.click();
    }
  </script>
</head>
<body>
  <div class="container">
    <div class="top-bar">
      <h1>ê´€ë¦¬ì í˜ì´ì§€</h1>
      <button class="logout-button" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
    <p>ê´€ë¦¬ì ID: <strong id="teacherName"></strong></p>

    <div id="viewTabs" class="filters"></div>

    <div class="filters">
      <label for="monthSelect">ì›”ë³„ ë³´ê¸°:</label>
      <input type="month" id="monthSelect" onchange="renderFilteredLogs()">

      <input type="hidden" id="selectedStudent">
      <button class="action" onclick="downloadAllCSV()">CSV ë‹¤ìš´ë¡œë“œ</button>
    </div>

    <div id="studentList" class="student-list"></div>
    <div id="commentHistory"></div>
  </div>
</body>
</html>
