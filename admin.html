<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>어드민 페이지</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background-color: #f4f9f4;
    }
    .container {
      display: flex;
      height: 100vh;
    }
    nav {
      width: 250px;
      background-color: #1f4d1f;
      color: white;
      padding: 20px;
      box-sizing: border-box;
      flex-shrink: 0;
    }
    nav h2 {
      font-size: 20px;
      margin-bottom: 20px;
      color: #c9f2ca;
    }
      .accordion-section {
      margin-bottom: 10px;
    }
    .accordion-button {
      background-color: transparent;
      color: white;
      border: none;
      padding: 10px;
      text-align: left;
      width: 100%;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .accordion-button:hover {
      background-color: #2e6b2e;
    }
    .accordion-content {
      display: none;
      flex-direction: column;
      padding-left: 10px;
      overflow: hidden;
      transition: max-height 0.3s ease-out, padding 0.3s ease-out;
      max-height: 0;
    }
    .accordion-content.show {
      max-height: 500px; /* 충분히 큰 값으로 설정 */
      padding: 10px 10px 10px 20px;
      display: flex;
    }
    .accordion-content button {
      background-color: #3b8c3b;
      color: white;
      border: none;
      padding: 8px;
      margin: 4px 0;
      text-align: left;
      width: 100%;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .accordion-content button:hover {
      background-color: #2e6b2e;
    }
    .main-panel {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
    }
    .tab-button {
      padding: 10px 20px;
      margin: 0 5px;
      border: none;
      border-radius: 6px;
      background-color: #64b668;
      color: white;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .tab-button.active {
      background-color: #125c17;
      font-weight: bold;
    }
    .tab-content {
      display: none;
      padding: 20px;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      max-width: 1000px;
      margin: 20px auto 0;
    }
    .tab-content.active {
      display: block;
    }
    .dynamic-content {
      padding: 20px;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      max-width: 1000px;
      margin: 20px auto 0;
      min-height: 300px;
    }
  </style>
</head>
<body>
  <div class="container">
    <nav>
      <h2>관리 메뉴</h2>

          <div class="accordion-section">
        <button class="accordion-button" onclick="toggleAccordion('student')">학생 관리</button>
        <div id="student" class="accordion-content">
          <button onclick="loadContent('입학')">입학</button>
          <button onclick="loadContent('퇴원')">퇴원</button>
          <button onclick="loadContent('반 추가')">반 추가</button>
          <button onclick="loadContent('반 삭제')">반 삭제</button>
          <button onclick="loadContent('반 바꿈')">반 바꿈</button>
        </div>
      </div>

          <div class="accordion-section">
        <button class="accordion-button" onclick="toggleAccordion('teacher')">선생님 관리</button>
        <div id="teacher" class="accordion-content">
          <button onclick="loadContent('선생님 추가')">선생님 추가</button>
          <button onclick="loadContent('선생님 삭제')">선생님 삭제</button>
        </div>
      </div>

          <div class="accordion-section">
        <button class="accordion-button" onclick="toggleAccordion('comments')">평가 관리</button>
        <div id="comments" class="accordion-content">
          <button onclick="showTabContent('today')">오늘의 평가</button>
          <button onclick="showTabContent('byClass')">반별 평가</button>
          <button onclick="showTabContent('byTeacher')">선생님별 평가</button>
          <button onclick="loadContent('평가 추가')">평가 추가</button>
        </div>
      </div>
    </nav>

    <div class="main-panel" id="mainPanel">
      <h2>관리자 페이지</h2>
      <div id="dynamicContent" class="dynamic-content">
        <p>왼쪽 메뉴에서 기능을 선택해주세요.</p>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getFirestore, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    // Firebase 설정 정보를 여기에 입력하세요.
    const firebaseConfig = {
  apiKey: "AIzaSyCQ460HGskAiS7PzP7POHNani7dmZLs1d0",
  authDomain: "claire-students-obs.firebaseapp.com",
  projectId: "claire-students-obs",
  storageBucket: "claire-students-obs.firebasestorage.app",
  messagingSenderId: "413871024792",
  appId: "1:413871024792:web:35b7cbbb3e3e9f25347eed",
  measurementId: "G-FS2L4K2VBG"
    };

    // Firebase 초기화
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // 전역 변수
    let allComments = [];
    let allClasses = [];
    let allStudents = [];
    let currentComments = []; // 이 부분을 추가해야 합니다.
    
    // CSV 변환 및 다운로드 함수
    function downloadAsCSV(data, filename) {
      const replacer = (key, value) => (value === null ? '' : value);
      const header = Object.keys(data[0]);
      let csv = data.map(row => header.map(fieldName => JSON.stringify(row[fieldName], replacer)).join(','));
      csv.unshift(header.join(','));
      csv = csv.join('\r\n');

      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      if (link.download !== undefined) {
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', filename);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }
    }


    // ======================= UI 관련 함수 =========================

    window.toggleAccordion = function(id) {
      const content = document.getElementById(id);
      const isVisible = content.classList.contains('show');
      document.querySelectorAll('.accordion-content').forEach(c => {
        if (c.id !== id) {
          c.classList.remove('show');
        }
      });
      if (!isVisible) {
        content.classList.add('show');
      }
    };

    // 메인 패널의 콘텐츠를 동적으로 로드하는 함수
    window.loadContent = function(contentName) {
      document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
      const dynamicContent = document.getElementById('dynamicContent');
      dynamicContent.classList.add('active');

      let contentHTML = '';
      switch (contentName) {
        case '입학':
          contentHTML = '<h3>입학 관리</h3><p>학생 입학 관련 기능이 여기에 표시됩니다.</p>';
          break;
        case '퇴원':
          contentHTML = '<h3>퇴원 관리</h3><p>학생 퇴원 관련 기능이 여기에 표시됩니다.</p>';
          break;
        case '반 추가':
          contentHTML = '<h3>반 추가</h3><p>새로운 반을 추가하는 기능이 여기에 표시됩니다.</p>';
          break;
        case '반 삭제':
          contentHTML = '<h3>반 삭제</h3><p>기존의 반을 삭제하는 기능이 여기에 표시됩니다.</p>';
          break;
        case '반 바꿈':
          contentHTML = '<h3>반 변경</h3><p>학생의 반을 변경하는 기능이 여기에 표시됩니다.</p>';
          break;
        case '선생님 추가':
          contentHTML = '<h3>선생님 추가</h3><p>새로운 선생님을 등록하는 기능이 여기에 표시됩니다.</p>';
          break;
        case '선생님 삭제':
          contentHTML = '<h3>선생님 삭제</h3><p>기존의 선생님을 삭제하는 기능이 여기에 표시됩니다.</p>';
          break;
        case '평가 추가':
          contentHTML = '<h3>평가 추가</h3><p>학생에게 새로운 평가를 추가하는 기능이 여기에 표시됩니다.</p>';
          break;
        default:
          contentHTML = '<h3>오류</h3><p>선택하신 기능에 대한 콘텐츠를 찾을 수 없습니다.</p>';
      }

      dynamicContent.innerHTML = contentHTML;
      document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
    };

    // 탭 콘텐츠를 보여주는 함수
    window.showTabContent = function(tabId) {
      document.getElementById('dynamicContent').classList.remove('active');

      document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

      const targetTab = document.querySelector(`.tab-button[data-tab="${tabId}"]`);
      const targetContent = document.getElementById(tabId);
      if (targetTab) {
        targetTab.classList.add('active');
      }
      if (targetContent) {
        targetContent.classList.add('active');
      }
    };

// ======================= Firebase 및 다운로드 함수 =========================

// Firebase에서 모든 학생 정보를 불러와 반 목록과 학생 목록을 UI에 바인딩
async function loadClassesAndStudents() {
  try {
    const classSelector = document.getElementById('classSelector');
    const studentSelector = document.getElementById('studentSelector');

    // 학생 정보 불러오기
    const studentSnapshot = await getDocs(collection(db, 'students'));
    allStudents = studentSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

    // students 컬렉션의 'class' 필드에서 중복 없는 반 목록 추출
    const classesSet = new Set(allStudents.map(s => s.class));
    allClasses = Array.from(classesSet).map(className => ({
      id: className,
      name: className
    }));

    // 반 선택 목록에 옵션 추가
    classSelector.innerHTML = '<option value="">모든 반</option>';
    allClasses.forEach(c => {
      const option = document.createElement('option');
      option.value = c.id; // 예: "HighUP(LG2)"
      option.textContent = c.name; // 예: "HighUP(LG2)"
      classSelector.appendChild(option);
    });

    // 반 선택 시 학생 목록 업데이트 이벤트 리스너
    classSelector.addEventListener('change', (e) => {
      updateStudentSelector(e.target.value);
    });

    // 초기 학생 선택 목록 설정 (모든 학생)
    updateStudentSelector('');

  } catch (e) {
    console.error("학생 및 반 정보를 불러오는 중 오류 발생: ", e);
  }
}

function updateStudentSelector(className) {
  const studentSelector = document.getElementById('studentSelector');
  studentSelector.innerHTML = '<option value="">모든 학생</option>';
  
  // 전달받은 반 이름(className)을 기준으로 학생 목록 필터링
  const studentsInClass = allStudents.filter(s => s.class === className);
  
  studentsInClass.forEach(s => {
    const option = document.createElement('option');
    option.value = s.id;  // 학생 고유 ID를 값으로 사용
    option.textContent = s.name; // 학생 이름을 텍스트로 표시
    studentSelector.appendChild(option);
  });
}
    

// 코멘트 목록을 화면에 표시하는 함수
function displayComments(comments, targetElement) {
  if (comments.length === 0) {
    targetElement.innerHTML = '<p>해당 조건에 맞는 코멘트가 없습니다.</p>';
    return;
  }

  let commentsHTML = '<h3>조회된 평가 목록</h3>';
  comments.forEach(comment => {
    commentsHTML += `
      <div style="border: 1px solid #ddd; padding: 10px; margin-bottom: 10px; border-radius: 5px;">
        <strong>날짜:</strong> ${comment.date}<br>
        <strong>선생님:</strong> ${comment.teacher}<br>
        <strong>학생:</strong> ${comment.student}<br>
        <p><strong>평가 내용:</strong> ${comment.comment}</p>
      </div>
    `;
  });
  
  targetElement.innerHTML = commentsHTML;
}
// ======================= 초기화 및 이벤트 리스너 =========================

    document.addEventListener('DOMContentLoaded', () => {
      const mainPanel = document.getElementById('mainPanel');
      const tabHTML = `
      <h2>코멘트 열람</h2>
    <div class="tabs">
      <button class="tab-button" data-tab="today">오늘의 평가</button>
      <button class="tab-button" data-tab="byClass">반별 보기</button>
      <button class="tab-button" data-tab="byTeacher">선생님별 보기</button>
    </div>
      
    <div id="today" class="tab-content">
      <h3>오늘의 평가</h3>
      <div id="todayComments">(여기에 오늘 날짜 기준 코멘트가 표시됩니다)</div>
    </div>
          
    <div id="byClass" class="tab-content active">
    <h3>반별 보기</h3>
    <label for="classSelector">반:</label>
    <select id="classSelector"></select>
    <label for="studentSelector">학생:</label>
    <select id="studentSelector"></select>
    <div style="margin-top: 10px;">
      <label for="startDate">시작일:</label>
      <input type="date" id="startDate">
      <label for="endDate">종료일:</label>
      <input type="date" id="endDate">
      <button onclick="fetchAndDisplayComments()">조회</button>
      <button id="downloadButton" onclick="downloadCommentsAsCSV()" style="display: none;">CSV 다운로드</button>
    </div>
    <div id="classComments" style="margin-top: 20px;">
      </div>
    </div>
      
  <div id="byTeacher" class="tab-content">
    <h3>선생님별 보기</h3>
    <label for="teacherSelector">선생님:</label>
    <select id="teacherSelector"></select>
    <div style="margin-top: 10px;">
      <label for="startTeacherDate">시작일:</label>
      <input type="date" id="startTeacherDate">
      <label for="endTeacherDate">종료일:</label>
      <input type="date" id="endTeacherDate">
      <button onclick="downloadCommentsByTeacher()">다운로드</button>
    </div>
    <div id="teacherComments">(선생님별 코멘트 표시)</div>
  </div>
      `;
      mainPanel.insertAdjacentHTML('beforeend', tabHTML);
      
      document.querySelectorAll('.tab-button').forEach(btn => {
        btn.addEventListener('click', () => {
          showTabContent(btn.dataset.tab);
        });
      });

      showTabContent('byClass');
      loadClassesAndStudents();
    });

    window.fetchAndDisplayComments = async function() {
    const className = document.getElementById('classSelector').value;
    const studentId = document.getElementById('studentSelector').value;
    const startDateStr = document.getElementById('startDate').value.replace(/-/g, '.');
    const endDateStr = document.getElementById('endDate').value.replace(/-/g, '.');
    const commentsDisplayArea = document.getElementById('classComments');
    const downloadBtn = document.getElementById('downloadButton');
    
    // 다운로드 버튼 숨기기
    downloadBtn.style.display = 'none';

    if (!className) {
        alert('반을 선택해주세요.');
        return;
    }

    commentsDisplayArea.innerHTML = '<p>데이터를 불러오는 중...</p>';

    let q = query(collection(db, 'comments'), where('class', '==', className));
    
    if (studentId) {
        q = query(q, where('studentId', '==', studentId));
    }
    if (startDateStr) {
        q = query(q, where('date', '>=', startDateStr));
    }
    if (endDateStr) {
        q = query(q, where('date', '<=', endDateStr));
    }

    try {
        const querySnapshot = await getDocs(q);
        const comments = querySnapshot.docs.map(doc => doc.data());
        
        // 전역 변수에 코멘트 저장
        currentComments = comments;

        // 화면에 코멘트 표시
        displayComments(comments, commentsDisplayArea);

        // 코멘트가 있을 때만 다운로드 버튼 표시
        if (comments.length > 0) {
            downloadBtn.style.display = 'inline-block';
        }

    } catch (e) {
        console.error("Error getting documents: ", e);
        commentsDisplayArea.innerHTML = '<p>데이터를 불러오는 중 오류가 발생했습니다.</p>';
    }
};

// CSV 다운로드 버튼 클릭 시: 전역 변수에 저장된 코멘트를 다운로드하는 함수
window.downloadCommentsAsCSV = function() {
    if (currentComments.length > 0) {
        const classSelector = document.getElementById('classSelector');
        const studentSelector = document.getElementById('studentSelector');
        const startDateInput = document.getElementById('startDate');

        const className = classSelector.value;
        const studentId = studentSelector.value;
        const startDate = startDateInput.value; // 'YYYY-MM-DD' 형식

        let filename = '';
        let monthString = '';

        // 시작일이 선택되었을 경우 'YYYY년MM월' 형식의 문자열 생성
        if (startDate) {
            const date = new Date(startDate);
            const year = date.getFullYear();
            const month = date.getMonth() + 1; // getMonth()는 0부터 시작하므로 1을 더함
            monthString = `_${year}년${month}월`;
        }

        if (studentId) {
            // 특정 학생이 선택된 경우
            const studentName = studentSelector.options[studentSelector.selectedIndex].textContent;
            filename = `${studentName}${monthString}_평가.csv`;
        } else {
            // '모든 학생'이 선택된 경우
            filename = `반별_평가_(${className})${monthString}.csv`;
        }
        
        downloadAsCSV(currentComments, filename);
    } else {
        alert('다운로드할 코멘트가 없습니다. 먼저 조회해주세요.');
    }
};

  </script>

</body>
</html>
